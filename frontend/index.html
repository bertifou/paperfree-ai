<!DOCTYPE html>
<html lang='fr'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>PaperFree-AI</title>
    <script src='https://cdn.tailwindcss.com'></script>
    <style>
        body { background-color: #f3f4f6; }
        .hidden { display: none; }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; font-weight: 600; }
        #pdfViewer { width: 100%; height: 500px; border: none; }
        .meta-badge { display: inline-block; padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; }
    </style>
</head>
<body class='p-4'>

<!-- LAYOUT PRINCIPAL -->
<div class='max-w-6xl mx-auto'>

    <!-- SETUP -->
    <div id='setupSection' class='hidden max-w-md mx-auto bg-white rounded-xl shadow-md p-6 mt-10'>
        <h1 class='text-2xl font-bold mb-1'>ğŸ“„ PaperFree-AI</h1>
        <p class='text-gray-500 text-sm mb-4'>Configuration initiale</p>
        <div class='space-y-3'>
            <input type='text' id='setupUser' placeholder="Nom d'utilisateur" class='w-full p-2 border rounded'>
            <input type='password' id='setupPass' placeholder='Mot de passe' class='w-full p-2 border rounded'>
            <input type='text' id='setupLlm' placeholder='URL API LLM (ex: http://192.168.1.102:1234/v1)' class='w-full p-2 border rounded'>
            <button onclick='handleSetup()' class='w-full bg-green-500 text-white p-2 rounded hover:bg-green-600'>Finaliser l'installation</button>
            <p id='setupError' class='text-red-500 text-sm hidden'></p>
        </div>
    </div>

    <!-- LOGIN -->
    <div id='loginSection' class='hidden max-w-md mx-auto bg-white rounded-xl shadow-md p-6 mt-10'>
        <h1 class='text-2xl font-bold mb-1'>ğŸ“„ PaperFree-AI</h1>
        <p class='text-gray-500 text-sm mb-4'>Connexion</p>
        <div class='space-y-3'>
            <input type='text' id='loginUser' placeholder='Utilisateur' class='w-full p-2 border rounded'>
            <input type='password' id='loginPass' placeholder='Mot de passe' class='w-full p-2 border rounded'>
            <button onclick='handleLogin()' class='w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600'>Se connecter</button>
            <p id='loginError' class='text-red-500 text-sm hidden'>Identifiants incorrects.</p>
        </div>
    </div>

    <!-- APP -->
    <div id='appSection' class='hidden'>

        <!-- HEADER -->
        <div class='bg-white rounded-xl shadow-sm p-4 mb-4 flex items-center justify-between'>
            <h1 class='text-xl font-bold text-gray-800'>ğŸ“„ PaperFree-AI</h1>
            <div class='flex gap-3'>
                <button onclick='showTab("docs")' id='btnDocs' class='text-sm px-3 py-1 rounded tab-active'>Documents</button>
                <button onclick='showTab("email")' id='btnEmail' class='text-sm px-3 py-1 rounded text-gray-500'>ğŸ“§ Emails</button>
                <button onclick='showTab("settings")' id='btnSettings' class='text-sm px-3 py-1 rounded text-gray-500'>ParamÃ¨tres</button>
                <button onclick='logout()' class='text-sm text-red-400 hover:text-red-600'>DÃ©connexion</button>
            </div>
        </div>

        <!-- TAB DOCUMENTS -->
        <div id='tabDocs' class='flex gap-4'>

            <!-- COLONNE GAUCHE: liste + upload + recherche -->
            <div class='w-80 flex-shrink-0 space-y-3'>

                <!-- Upload -->
                <div class='bg-white rounded-xl shadow-sm p-4'>
                    <input type='file' id='fileInput' class='hidden' accept='image/*,application/pdf' capture='environment'>
                    <button onclick='document.getElementById("fileInput").click()'
                        class='w-full bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600 text-sm font-medium'>
                        ğŸ“¸ Scanner / TÃ©lÃ©verser
                    </button>
                    <p id='uploadStatus' class='text-xs text-gray-400 mt-1 text-center hidden'>Traitement en cours...</p>
                </div>

                <!-- Recherche -->
                <div class='bg-white rounded-xl shadow-sm p-4 space-y-2'>
                    <div class='flex gap-2'>
                        <input type='text' id='searchInput' placeholder='Rechercher...'
                            class='flex-1 p-2 border rounded text-sm' onkeydown='if(event.key==="Enter") doSearch("text")'>
                        <button onclick='doSearch("text")' class='bg-gray-100 hover:bg-gray-200 px-3 rounded text-sm'>ğŸ”</button>
                    </div>
                    <button onclick='doSearch("llm")'
                        class='w-full bg-purple-50 hover:bg-purple-100 text-purple-700 py-1.5 px-3 rounded text-sm font-medium border border-purple-200'>
                        âœ¨ Demander au LLM
                    </button>
                    <div id='llmAnswer' class='hidden bg-purple-50 rounded p-3 text-sm text-purple-900 border border-purple-200'></div>
                </div>

                <!-- Liste documents -->
                <div class='bg-white rounded-xl shadow-sm p-4'>
                    <h2 class='text-sm font-semibold text-gray-600 mb-2'>MES DOCUMENTS</h2>
                    <div id='docList' class='space-y-2 max-h-[60vh] overflow-y-auto'></div>
                </div>
            </div>

            <!-- COLONNE DROITE: panneau de dÃ©tail -->
            <div class='flex-1 bg-white rounded-xl shadow-sm p-4' id='detailPanel'>
                <div class='flex items-center justify-center h-64 text-gray-300 flex-col gap-2'>
                    <span class='text-5xl'>ğŸ“„</span>
                    <span class='text-sm'>SÃ©lectionnez un document</span>
                </div>
            </div>
        </div>

        <!-- TAB EMAIL -->
        <div id='tabEmail' class='hidden space-y-4'>

            <!-- Barre d'actions -->
            <div class='bg-white rounded-xl shadow-sm p-4 flex flex-wrap gap-3 items-center'>
                <select id='emailFolderSelect' onchange='loadEmails()'
                    class='border rounded px-3 py-1.5 text-sm text-gray-700 bg-gray-50'>
                    <option value='INBOX'>INBOX</option>
                </select>
                <button onclick='loadEmails()'
                    class='bg-blue-500 text-white px-4 py-1.5 rounded text-sm hover:bg-blue-600'>ğŸ”„ Actualiser</button>
                <button onclick='syncAttachments()'
                    class='bg-green-500 text-white px-4 py-1.5 rounded text-sm hover:bg-green-600'>ğŸ“ Sync piÃ¨ces jointes</button>
                <button onclick='purgePromo(false)'
                    class='bg-orange-500 text-white px-4 py-1.5 rounded text-sm hover:bg-orange-600'>ğŸ—‘ Purger promotionnels</button>
                <button onclick='purgePromo(true)'
                    class='bg-gray-200 text-gray-700 px-4 py-1.5 rounded text-sm hover:bg-gray-300'>ğŸ‘ Simuler purge</button>
                <span id='emailActionMsg' class='text-sm text-green-600 hidden'></span>
            </div>

            <!-- Stats rapides -->
            <div id='emailStats' class='hidden bg-white rounded-xl shadow-sm p-4 text-sm text-gray-600'></div>

            <!-- Liste des emails -->
            <div class='bg-white rounded-xl shadow-sm overflow-hidden'>
                <div id='emailLoading' class='hidden p-6 text-center text-gray-400 text-sm'>Chargement...</div>
                <div id='emailEmpty'   class='hidden p-6 text-center text-gray-400 text-sm'>Aucun email dans ce dossier.</div>
                <table class='w-full text-sm' id='emailTable'>
                    <thead class='bg-gray-50 text-xs text-gray-500 uppercase'>
                        <tr>
                            <th class='px-4 py-2 text-left w-6'></th>
                            <th class='px-4 py-2 text-left'>ExpÃ©diteur</th>
                            <th class='px-4 py-2 text-left'>Sujet</th>
                            <th class='px-4 py-2 text-left'>Date</th>
                            <th class='px-4 py-2 text-center'>PJ</th>
                            <th class='px-4 py-2 text-right'>Actions</th>
                        </tr>
                    </thead>
                    <tbody id='emailList'></tbody>
                </table>
            </div>

            <!-- Historique des logs -->
            <div class='bg-white rounded-xl shadow-sm p-4'>
                <div class='flex items-center justify-between mb-3'>
                    <h3 class='text-sm font-semibold text-gray-600'>HISTORIQUE DES ACTIONS</h3>
                    <button onclick='loadEmailLogs()' class='text-xs text-blue-500 hover:underline'>Actualiser</button>
                </div>
                <div id='emailLogs' class='max-h-48 overflow-y-auto space-y-1'></div>
            </div>
        </div>

        <!-- TAB SETTINGS -->
        <div id='tabSettings' class='hidden bg-white rounded-xl shadow-sm p-6 max-w-lg'>
            <h2 class='text-lg font-semibold mb-4'>ParamÃ¨tres LLM</h2>
            <div class='space-y-3'>
                <div>
                    <label class='block text-sm font-medium text-gray-700 mb-1'>URL de base de l'API</label>
                    <input type='text' id='settingLlmUrl' class='w-full p-2 border rounded text-sm' placeholder='http://localhost:1234/v1'>
                    <p class='text-xs text-gray-400 mt-1'>LM Studio: :1234/v1 Â· Ollama: :11434/v1 Â· OpenAI: api.openai.com/v1</p>
                </div>
                <div>
                    <label class='block text-sm font-medium text-gray-700 mb-1'>ModÃ¨le</label>
                    <input type='text' id='settingLlmModel' class='w-full p-2 border rounded text-sm' placeholder='local-model'>
                </div>
                <div>
                    <label class='block text-sm font-medium text-gray-700 mb-1'>ClÃ© API</label>
                    <input type='text' id='settingLlmKey' class='w-full p-2 border rounded text-sm' placeholder='lm-studio'>
                </div>
                <button onclick='saveSettings()' class='bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 text-sm'>
                    Enregistrer
                </button>
                <p id='settingsSaved' class='text-green-600 text-sm hidden'>âœ“ ParamÃ¨tres enregistrÃ©s</p>
            </div>

            <!-- ParamÃ¨tres Email -->
            <div class='mt-8 pt-6 border-t'>
                <h2 class='text-lg font-semibold mb-1'>ğŸ“§ Compte Email IMAP</h2>
                <p class='text-xs text-gray-400 mb-4'>Gmail : imap.gmail.com Â· Outlook : outlook.office365.com</p>
                <div class='space-y-3'>
                    <div class='grid grid-cols-2 gap-3'>
                <div>
                    <label class='block text-sm font-medium text-gray-700 mb-1'>Serveur IMAP</label>
                    <input type='text' id='settingEmailHost' class='w-full p-2 border rounded text-sm' placeholder='imap-mail.outlook.com'>
                    <p class='text-xs text-gray-400 mt-1'>
                        Hotmail/Outlook perso : <code class='bg-gray-100 px-1 rounded cursor-pointer' onclick='document.getElementById("settingEmailHost").value="imap-mail.outlook.com"'>imap-mail.outlook.com</code> Â·
                        Microsoft 365 pro : <code class='bg-gray-100 px-1 rounded cursor-pointer' onclick='document.getElementById("settingEmailHost").value="outlook.office365.com"'>outlook.office365.com</code> Â·
                        Gmail : <code class='bg-gray-100 px-1 rounded cursor-pointer' onclick='document.getElementById("settingEmailHost").value="imap.gmail.com"'>imap.gmail.com</code>
                    </p>
                </div>
                        <div>
                            <label class='block text-sm font-medium text-gray-700 mb-1'>Adresse email</label>
                            <input type='text' id='settingEmailUser' class='w-full p-2 border rounded text-sm' placeholder='vous@gmail.com'>
                        </div>
                    </div>
                    <div>
                        <label class='block text-sm font-medium text-gray-700 mb-1'>Mot de passe (ou mot de passe d'application)</label>
                        <input type='password' id='settingEmailPass' class='w-full p-2 border rounded text-sm' placeholder='â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'>
                    </div>
                    <div class='grid grid-cols-2 gap-3'>
                        <div>
                            <label class='block text-sm font-medium text-gray-700 mb-1'>Dossier surveillÃ©</label>
                            <input type='text' id='settingEmailFolder' class='w-full p-2 border rounded text-sm' placeholder='INBOX'>
                        </div>
                        <div>
                            <label class='block text-sm font-medium text-gray-700 mb-1'>Dossier "TraitÃ©"</label>
                            <input type='text' id='settingEmailTreated' class='w-full p-2 border rounded text-sm' placeholder='PaperFree-TraitÃ©'>
                        </div>
                    </div>
                    <div class='grid grid-cols-3 gap-3'>
                        <div>
                            <label class='block text-sm font-medium text-gray-700 mb-1'>Sync PJ (min)</label>
                            <input type='number' id='settingEmailAttachInterval' class='w-full p-2 border rounded text-sm' placeholder='15'>
                        </div>
                        <div>
                            <label class='block text-sm font-medium text-gray-700 mb-1'>Purge (heures)</label>
                            <input type='number' id='settingEmailPurgeInterval' class='w-full p-2 border rounded text-sm' placeholder='24'>
                        </div>
                        <div>
                            <label class='block text-sm font-medium text-gray-700 mb-1'>Ã‚ge promo (jours)</label>
                            <input type='number' id='settingEmailPromoDays' class='w-full p-2 border rounded text-sm' placeholder='7'>
                        </div>
                    </div>
                    <button onclick='saveEmailSettings()' class='bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 text-sm'>
                        Enregistrer la config email
                    </button>
                    <button onclick='testEmailConnection()' class='ml-2 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded text-sm'>
                        ğŸ”Œ Tester la connexion
                    </button>
                    <p id='emailSettingsSaved' class='text-green-600 text-sm hidden mt-1'>âœ“ Config email sauvegardÃ©e</p>
                    <p id='emailTestResult'   class='text-sm mt-1 hidden'></p>
                </div>
            </div>

            <!-- OAuth2 Microsoft -->
            <div class='mt-8 pt-6 border-t'>
                <h2 class='text-lg font-semibold mb-1'>ğŸ” OAuth2 Microsoft <span class='text-sm font-normal text-gray-400'>(requis pour Hotmail/Outlook)</span></h2>
                <p class='text-xs text-gray-400 mb-4'>
                    Enregistrez une app sur
                    <a href='https://portal.azure.com' target='_blank' class='text-blue-500 underline'>portal.azure.com</a>
                    â†’ Azure Active Directory â†’ Inscriptions d'applications â†’ Nouvelle inscription.<br>
                    Type : <b>Comptes Microsoft personnels uniquement</b> Â· URI de redirection : <code class='bg-gray-100 px-1'>http://localhost:8000/email/oauth/callback</code>
                </p>
                <div class='space-y-3'>
                    <div class='grid grid-cols-2 gap-3'>
                        <div>
                            <label class='block text-sm font-medium text-gray-700 mb-1'>Client ID (Application ID)</label>
                            <input type='text' id='settingOauthClientId' class='w-full p-2 border rounded text-sm font-mono' placeholder='xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx'>
                        </div>
                        <div>
                            <label class='block text-sm font-medium text-gray-700 mb-1'>Client Secret</label>
                            <input type='password' id='settingOauthClientSecret' class='w-full p-2 border rounded text-sm' placeholder='Valeur du secret'>
                        </div>
                    </div>
                    <div>
                        <label class='block text-sm font-medium text-gray-700 mb-1'>URI de redirection</label>
                        <input type='text' id='settingOauthRedirectUri' class='w-full p-2 border rounded text-sm font-mono' placeholder='http://localhost:8000/email/oauth/callback'>
                        <p class='text-xs text-gray-400 mt-1'>Doit correspondre exactement Ã  l'URI configurÃ©e dans Azure.</p>
                    </div>
                    <div class='flex gap-3 items-center flex-wrap'>
                        <button onclick='saveOauthSettings()' class='bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-800 text-sm'>
                            Enregistrer
                        </button>
                        <button onclick='startOauthFlow()' id='btnOauthConnect'
                            class='bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm font-medium'>
                            ğŸ”‘ Connecter mon compte Outlook/Hotmail
                        </button>
                        <button onclick='oauthDisconnect()' id='btnOauthDisconnect' class='hidden bg-red-50 text-red-600 px-4 py-2 rounded hover:bg-red-100 text-sm'>
                            DÃ©connecter
                        </button>
                        <span id='oauthStatus' class='text-sm'></span>
                    </div>
                    <p id='oauthSettingsSaved' class='text-green-600 text-sm hidden'>âœ“ Config OAuth sauvegardÃ©e</p>
                </div>
            </div>
        </div>

    </div><!-- /appSection -->
</div>

<script>
const API_URL = 'http://localhost:8000';
let authHeader = localStorage.getItem('paperfree_auth');
let currentDocId = null;
let allDocs = [];

// â”€â”€â”€ Auth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkStatus() {
    const res = await fetch(`${API_URL}/status`);
    const data = await res.json();
    if (data.setup_required) { showSection('setup'); }
    else if (!authHeader)    { showSection('login'); }
    else { showSection('app'); loadDocuments(); loadSettings(); }
}

function showSection(name) {
    ['setup','login','app'].forEach(s => document.getElementById(s+'Section').classList.add('hidden'));
    document.getElementById(name+'Section').classList.remove('hidden');
}

async function handleSetup() {
    const user = document.getElementById('setupUser').value;
    const pass = document.getElementById('setupPass').value;
    const url  = document.getElementById('setupLlm').value;
    const res = await fetch(`${API_URL}/setup?username=${encodeURIComponent(user)}&password=${encodeURIComponent(pass)}&llm_url=${encodeURIComponent(url)}`, { method: 'POST' });
    if (res.ok) { showSection('login'); }
    else {
        const err = document.getElementById('setupError');
        err.textContent = (await res.json()).detail || 'Erreur';
        err.classList.remove('hidden');
    }
}

async function handleLogin() {
    const user = document.getElementById('loginUser').value;
    const pass = document.getElementById('loginPass').value;
    authHeader = 'Basic ' + btoa(user + ':' + pass);
    const res = await fetch(`${API_URL}/documents`, { headers: { 'Authorization': authHeader } });
    if (res.status === 401) {
        document.getElementById('loginError').classList.remove('hidden');
        authHeader = null;
    } else {
        localStorage.setItem('paperfree_auth', authHeader);
        showSection('app');
        loadDocuments();
        loadSettings();
    }
}

function logout() {
    localStorage.removeItem('paperfree_auth');
    authHeader = null;
    checkStatus();
}

// â”€â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTab(name) {
    document.getElementById('tabDocs').classList.toggle('hidden',     name !== 'docs');
    document.getElementById('tabEmail').classList.toggle('hidden',    name !== 'email');
    document.getElementById('tabSettings').classList.toggle('hidden', name !== 'settings');
    document.getElementById('btnDocs').className     = 'text-sm px-3 py-1 rounded ' + (name==='docs'     ? 'tab-active' : 'text-gray-500');
    document.getElementById('btnEmail').className    = 'text-sm px-3 py-1 rounded ' + (name==='email'    ? 'tab-active' : 'text-gray-500');
    document.getElementById('btnSettings').className = 'text-sm px-3 py-1 rounded ' + (name==='settings' ? 'tab-active' : 'text-gray-500');
    if (name === 'email') { loadEmailFolders(); loadEmails(); loadEmailLogs(); }
}

// â”€â”€â”€ Documents â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CATEGORY_COLORS = {
    'Facture':'bg-orange-100 text-orange-700','ImpÃ´ts':'bg-red-100 text-red-700',
    'SantÃ©':'bg-green-100 text-green-700','Banque':'bg-blue-100 text-blue-700',
    'Contrat':'bg-purple-100 text-purple-700','Assurance':'bg-yellow-100 text-yellow-700',
    'Travail':'bg-indigo-100 text-indigo-700','Courrier':'bg-gray-100 text-gray-700',
    'Autre':'bg-gray-100 text-gray-500',
};

function renderDocList(docs) {
    const el = document.getElementById('docList');
    if (!docs.length) { el.innerHTML = '<p class="text-gray-400 text-sm">Aucun document.</p>'; return; }
    el.innerHTML = docs.map(d => {
        const color = CATEGORY_COLORS[d.category] || 'bg-gray-100 text-gray-500';
        const processing = !d.category;
        return `<div onclick='openDoc(${d.id})'
            class='p-3 rounded-lg border cursor-pointer hover:border-blue-300 hover:bg-blue-50 transition ${currentDocId===d.id?"border-blue-400 bg-blue-50":"border-gray-200"}'>
            <div class='flex items-start justify-between gap-2'>
                <span class='text-sm font-medium text-gray-800 truncate flex-1'>${d.filename}</span>
                ${processing
                    ? `<span class='meta-badge bg-gray-100 text-gray-400 animate-pulse'>â³</span>`
                    : `<span class='meta-badge ${color}'>${d.category}</span>`}
            </div>
            ${d.summary ? `<p class='text-xs text-gray-500 mt-1 truncate'>${d.summary}</p>` : ''}
            ${d.issuer  ? `<p class='text-xs text-gray-400 mt-0.5'>${d.issuer}</p>` : ''}
            <p class='text-xs text-gray-300 mt-1'>${new Date(d.created_at).toLocaleDateString('fr-CA')}</p>
        </div>`;
    }).join('');
}

async function loadDocuments() {
    try {
        const res = await fetch(`${API_URL}/documents`, { headers: { 'Authorization': authHeader } });
        if (res.status === 401) return logout();
        allDocs = await res.json();
        renderDocList(allDocs);
    } catch(e) {}
}

// â”€â”€â”€ DÃ©tail document â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openDoc(id) {
    currentDocId = id;
    renderDocList(allDocs); // update selection highlight

    const res = await fetch(`${API_URL}/documents/${id}`, { headers: { 'Authorization': authHeader } });
    const doc = await res.json();

    // Merge form_data overrides
    let formData = {};
    try { if (doc.form_data) formData = JSON.parse(doc.form_data); } catch(e) {}

    const isPdf = doc.filename.toLowerCase().endsWith('.pdf');
    const fileUrl = `${API_URL}/documents/${id}/file`;
    const color = CATEGORY_COLORS[doc.category] || 'bg-gray-100 text-gray-500';

    document.getElementById('detailPanel').innerHTML = `
        <div class='flex items-start justify-between mb-4 gap-2'>
            <div class='flex-1 min-w-0'>
                <h2 class='text-lg font-bold text-gray-800 truncate'>${doc.filename}</h2>
                <div class='flex flex-wrap gap-2 mt-1'>
                    ${doc.category ? `<span class='meta-badge ${color}'>${doc.category}</span>` : ''}
                    ${doc.issuer   ? `<span class='meta-badge bg-gray-100 text-gray-600'>ğŸ¢ ${doc.issuer}</span>` : ''}
                    ${doc.doc_date ? `<span class='meta-badge bg-blue-50 text-blue-600'>ğŸ“… ${doc.doc_date}</span>` : ''}
                    ${doc.amount   ? `<span class='meta-badge bg-green-50 text-green-700'>ğŸ’¶ ${doc.amount}</span>` : ''}
                </div>
            </div>
            <div class='flex gap-2 flex-shrink-0'>
                <a href='${fileUrl}' target='_blank'
                    class='text-xs bg-gray-100 hover:bg-gray-200 px-3 py-1.5 rounded font-medium'>â¬‡ TÃ©lÃ©charger</a>
                <button onclick='deleteDoc(${doc.id})'
                    class='text-xs bg-red-50 hover:bg-red-100 text-red-600 px-3 py-1.5 rounded font-medium'>ğŸ—‘ Supprimer</button>
            </div>
        </div>

        <!-- Onglets -->
        <div class='flex gap-4 border-b mb-4 text-sm'>
            <button onclick='showDocTab("preview")'  id='dtPreview'  class='pb-2 tab-active'>AperÃ§u</button>
            <button onclick='showDocTab("ocr")'      id='dtOcr'      class='pb-2 text-gray-500'>Texte OCR</button>
            <button onclick='showDocTab("form")'     id='dtForm'     class='pb-2 text-gray-500'>ğŸ“ Formulaire</button>
        </div>

        <!-- AperÃ§u -->
        <div id='dtTabPreview'>
            ${isPdf
                ? `<iframe src='${fileUrl}' id='pdfViewer'></iframe>`
                : `<img src='${fileUrl}' class='max-w-full rounded border' alt='${doc.filename}'
                    onerror="this.outerHTML='<p class=text-gray-400 text-sm>AperÃ§u indisponible.</p>'">`
            }
        </div>

        <!-- OCR -->
        <div id='dtTabOcr' class='hidden'>
            ${doc.content
                ? `<pre class='text-xs text-gray-700 bg-gray-50 rounded p-4 overflow-auto max-h-[55vh] whitespace-pre-wrap font-mono'>${escHtml(doc.content)}</pre>`
                : `<p class='text-gray-400 text-sm'>Texte non encore extrait ou document en cours de traitement.</p>`}
        </div>

        <!-- Formulaire -->
        <div id='dtTabForm' class='hidden'>
            <p class='text-xs text-gray-400 mb-3'>Champs prÃ©-remplis par le LLM â€” Ã©ditables et sauvegardables.</p>
            <div class='grid grid-cols-2 gap-3 mb-4'>
                ${formField('CatÃ©gorie','category', formData.category||doc.category||'')}
                ${formField('Ã‰metteur','issuer', formData.issuer||doc.issuer||'')}
                ${formField('Date','doc_date', formData.doc_date||doc.doc_date||'')}
                ${formField('Montant','amount', formData.amount||doc.amount||'')}
            </div>
            <div class='mb-4'>
                <label class='block text-xs font-medium text-gray-600 mb-1'>RÃ©sumÃ©</label>
                <textarea id='form_summary' rows='2'
                    class='w-full p-2 border rounded text-sm'>${escHtml(formData.summary||doc.summary||'')}</textarea>
            </div>
            <div class='mb-4'>
                <label class='block text-xs font-medium text-gray-600 mb-1'>Notes personnelles</label>
                <textarea id='form_notes' rows='3'
                    class='w-full p-2 border rounded text-sm'>${escHtml(formData.notes||'')}</textarea>
            </div>
            <button onclick='saveForm(${doc.id})'
                class='bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded text-sm font-medium'>
                ğŸ’¾ Sauvegarder
            </button>
            <span id='formSaved' class='hidden text-green-600 text-sm ml-3'>âœ“ SauvegardÃ©</span>
        </div>
    `;
}

function formField(label, key, value) {
    return `<div>
        <label class='block text-xs font-medium text-gray-600 mb-1'>${label}</label>
        <input type='text' id='form_${key}' value='${escAttr(value)}'
            class='w-full p-2 border rounded text-sm'>
    </div>`;
}

function showDocTab(name) {
    ['preview','ocr','form'].forEach(t => {
        document.getElementById('dtTab'+cap(t)).classList.toggle('hidden', t!==name);
        const btn = document.getElementById('dt'+cap(t));
        btn.className = 'pb-2 ' + (t===name ? 'tab-active' : 'text-gray-500');
    });
}

async function saveForm(docId) {
    const data = {
        category: document.getElementById('form_category').value,
        issuer:   document.getElementById('form_issuer').value,
        doc_date: document.getElementById('form_doc_date').value,
        amount:   document.getElementById('form_amount').value,
        summary:  document.getElementById('form_summary').value,
        notes:    document.getElementById('form_notes').value,
    };
    await fetch(`${API_URL}/documents/${docId}/form`, {
        method: 'PATCH',
        headers: { 'Authorization': authHeader, 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
    });
    const el = document.getElementById('formSaved');
    el.classList.remove('hidden');
    setTimeout(() => el.classList.add('hidden'), 2000);
    loadDocuments(); // rafraÃ®chir la liste
}

async function deleteDoc(docId) {
    if (!confirm('Supprimer ce document ?')) return;
    await fetch(`${API_URL}/documents/${docId}`, {
        method: 'DELETE', headers: { 'Authorization': authHeader }
    });
    currentDocId = null;
    document.getElementById('detailPanel').innerHTML =
        '<div class="flex items-center justify-center h-64 text-gray-300 flex-col gap-2"><span class="text-5xl">ğŸ“„</span><span class="text-sm">SÃ©lectionnez un document</span></div>';
    loadDocuments();
}

// â”€â”€â”€ Recherche â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doSearch(mode) {
    const q = document.getElementById('searchInput').value.trim();
    if (!q) { loadDocuments(); return; }

    const res = await fetch(`${API_URL}/search?q=${encodeURIComponent(q)}&mode=${mode}`, {
        headers: { 'Authorization': authHeader }
    });
    const data = await res.json();

    allDocs = data.results;
    renderDocList(allDocs);

    const llmBox = document.getElementById('llmAnswer');
    if (mode === 'llm' && data.llm_answer) {
        llmBox.textContent = data.llm_answer;
        llmBox.classList.remove('hidden');
    } else {
        llmBox.classList.add('hidden');
    }
}

// â”€â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSettings() {
    const res = await fetch(`${API_URL}/settings`, { headers: { 'Authorization': authHeader } });
    const s = await res.json();
    document.getElementById('settingLlmUrl').value   = s.llm_base_url || '';
    document.getElementById('settingLlmModel').value = s.llm_model    || '';
    document.getElementById('settingLlmKey').value   = s.llm_api_key  || '';
    // Email
    document.getElementById('settingEmailHost').value           = s.email_host                 || '';
    document.getElementById('settingEmailUser').value           = s.email_user                 || '';
    document.getElementById('settingEmailPass').value           = s.email_password             || '';
    document.getElementById('settingEmailFolder').value         = s.email_folder               || 'INBOX';
    document.getElementById('settingEmailTreated').value        = s.email_treated_folder       || 'PaperFree-TraitÃ©';
    document.getElementById('settingEmailAttachInterval').value = s.email_attach_interval_min  || '15';
    document.getElementById('settingEmailPurgeInterval').value  = s.email_purge_interval_hours || '24';
    document.getElementById('settingEmailPromoDays').value      = s.email_promo_days           || '7';
    // OAuth
    document.getElementById('settingOauthClientId').value     = s.oauth_client_id     || '';
    document.getElementById('settingOauthClientSecret').value = s.oauth_client_secret || '';
    document.getElementById('settingOauthRedirectUri').value  = s.oauth_redirect_uri  || 'http://localhost:8000/email/oauth/callback';
    refreshOauthStatus();
}

async function saveSettings() {
    const pairs = [
        ['llm_base_url', document.getElementById('settingLlmUrl').value],
        ['llm_model',    document.getElementById('settingLlmModel').value],
        ['llm_api_key',  document.getElementById('settingLlmKey').value],
    ];
    for (const [k, v] of pairs) {
        await fetch(`${API_URL}/settings?key=${k}&value=${encodeURIComponent(v)}`,
            { method: 'POST', headers: { 'Authorization': authHeader } });
    }
    const el = document.getElementById('settingsSaved');
    el.classList.remove('hidden');
    setTimeout(() => el.classList.add('hidden'), 2000);
}

async function saveEmailSettings() {
    const pairs = [
        ['email_host',                 document.getElementById('settingEmailHost').value],
        ['email_user',                 document.getElementById('settingEmailUser').value],
        ['email_password',             document.getElementById('settingEmailPass').value],
        ['email_folder',               document.getElementById('settingEmailFolder').value],
        ['email_treated_folder',       document.getElementById('settingEmailTreated').value],
        ['email_attach_interval_min',  document.getElementById('settingEmailAttachInterval').value],
        ['email_purge_interval_hours', document.getElementById('settingEmailPurgeInterval').value],
        ['email_promo_days',           document.getElementById('settingEmailPromoDays').value],
    ];
    for (const [k, v] of pairs) {
        await fetch(`${API_URL}/settings?key=${k}&value=${encodeURIComponent(v)}`,
            { method: 'POST', headers: { 'Authorization': authHeader } });
    }
    const el = document.getElementById('emailSettingsSaved');
    el.classList.remove('hidden');
    setTimeout(() => el.classList.add('hidden'), 3000);
}

async function testEmailConnection() {
    const res = await fetch(`${API_URL}/email/folders`, { headers: { 'Authorization': authHeader } });
    const el = document.getElementById('emailTestResult');
    el.classList.remove('hidden');
    if (res.ok) {
        const data = await res.json();
        el.textContent = `âœ… Connexion rÃ©ussie â€” ${data.folders.length} dossier(s) trouvÃ©(s)`;
        el.className = 'text-sm mt-1 text-green-600';
    } else {
        const err = await res.json();
        el.textContent = `âŒ Erreur : ${err.detail || 'Connexion impossible'}`;
        el.className = 'text-sm mt-1 text-red-600';
    }
    setTimeout(() => el.classList.add('hidden'), 5000);
}

async function saveOauthSettings() {
    const pairs = [
        ['oauth_client_id',     document.getElementById('settingOauthClientId').value],
        ['oauth_client_secret', document.getElementById('settingOauthClientSecret').value],
        ['oauth_redirect_uri',  document.getElementById('settingOauthRedirectUri').value],
    ];
    for (const [k, v] of pairs) {
        await fetch(`${API_URL}/settings?key=${k}&value=${encodeURIComponent(v)}`,
            { method: 'POST', headers: { 'Authorization': authHeader } });
    }
    document.getElementById('oauthSettingsSaved').classList.remove('hidden');
    setTimeout(() => document.getElementById('oauthSettingsSaved').classList.add('hidden'), 3000);
}

async function refreshOauthStatus() {
    try {
        const res  = await fetch(`${API_URL}/email/oauth/status`, { headers: { 'Authorization': authHeader } });
        if (!res.ok) return;
        const data = await res.json();
        const el   = document.getElementById('oauthStatus');
        const btnConnect    = document.getElementById('btnOauthConnect');
        const btnDisconnect = document.getElementById('btnOauthDisconnect');
        if (data.connected) {
            const exp = data.expires_at ? new Date(data.expires_at * 1000).toLocaleString('fr-CA') : '?';
            el.innerHTML = `<span class='text-green-600'>âœ… ConnectÃ© (${escHtml(data.email_user)}) â€” expire ${exp}</span>`;
            btnConnect.classList.add('hidden');
            btnDisconnect.classList.remove('hidden');
        } else if (data.configured) {
            el.innerHTML = `<span class='text-orange-500'>âš ï¸ App configurÃ©e mais non connectÃ©e â€” cliquez "Connecter"</span>`;
            btnConnect.classList.remove('hidden');
            btnDisconnect.classList.add('hidden');
        } else {
            el.innerHTML = `<span class='text-gray-400'>Non configurÃ©</span>`;
            btnConnect.classList.remove('hidden');
            btnDisconnect.classList.add('hidden');
        }
    } catch(e) {}
}

function startOauthFlow() {
    // Ouvre la popup Microsoft dans une nouvelle fenÃªtre
    const popup = window.open(
        `${API_URL}/email/oauth/start`,
        'oauth_popup',
        'width=520,height=640,resizable=yes,scrollbars=yes'
    );
    // Ã‰couter le message de retour depuis la popup
    const handler = (event) => {
        if (event.data?.type === 'oauth_success') {
            window.removeEventListener('message', handler);
            popup?.close();
            refreshOauthStatus();
            showEmailMsg('âœ… Compte Outlook/Hotmail connectÃ© avec succÃ¨s !', 'green');
        } else if (event.data?.type === 'oauth_error') {
            window.removeEventListener('message', handler);
            popup?.close();
            showEmailMsg(`âŒ Erreur OAuth : ${event.data.error}`, 'red');
        }
    };
    window.addEventListener('message', handler);
    // Nettoyer si la popup est fermÃ©e manuellement
    const interval = setInterval(() => {
        if (popup?.closed) { clearInterval(interval); window.removeEventListener('message', handler); }
    }, 1000);
}

async function oauthDisconnect() {
    if (!confirm('DÃ©connecter le compte Outlook/Hotmail ?')) return;
    await fetch(`${API_URL}/email/oauth/disconnect`,
        { method: 'POST', headers: { 'Authorization': authHeader } });
    refreshOauthStatus();
}

// â”€â”€â”€ Email â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const EMAIL_CATEGORY_COLORS = {
    'Promotionnel': 'bg-orange-100 text-orange-700',
    'Facture':      'bg-blue-100 text-blue-700',
    'Notification': 'bg-yellow-100 text-yellow-700',
    'Personnel':    'bg-green-100 text-green-700',
    'Autre':        'bg-gray-100 text-gray-500',
};

async function loadEmailFolders() {
    try {
        const res = await fetch(`${API_URL}/email/folders`, { headers: { 'Authorization': authHeader } });
        if (!res.ok) return;
        const data = await res.json();
        const sel = document.getElementById('emailFolderSelect');
        const current = sel.value;
        sel.innerHTML = '';
        data.folders.forEach(f => {
            const opt = document.createElement('option');
            opt.value = f; opt.textContent = f;
            if (f === current) opt.selected = true;
            sel.appendChild(opt);
        });
    } catch(e) {}
}

async function loadEmails() {
    const folder = document.getElementById('emailFolderSelect').value || 'INBOX';
    document.getElementById('emailLoading').classList.remove('hidden');
    document.getElementById('emailEmpty').classList.add('hidden');
    document.getElementById('emailList').innerHTML = '';
    document.getElementById('emailStats').classList.add('hidden');
    try {
        const res = await fetch(`${API_URL}/email/messages?folder=${encodeURIComponent(folder)}&limit=50`,
            { headers: { 'Authorization': authHeader } });
        document.getElementById('emailLoading').classList.add('hidden');
        if (!res.ok) {
            const err = await res.json();
            document.getElementById('emailEmpty').textContent = `âš ï¸ ${err.detail || 'Erreur'}`;
            document.getElementById('emailEmpty').classList.remove('hidden');
            return;
        }
        const data = await res.json();
        if (!data.messages.length) {
            document.getElementById('emailEmpty').classList.remove('hidden');
            return;
        }
        const unread = data.messages.filter(m => !m.is_read).length;
        const withPJ = data.messages.filter(m => m.has_attachment).length;
        const stats  = document.getElementById('emailStats');
        stats.textContent = `${data.count} email(s) â€” ${unread} non lu(s) â€” ${withPJ} avec piÃ¨ce(s) jointe(s)`;
        stats.classList.remove('hidden');

        const tbody = document.getElementById('emailList');
        tbody.innerHTML = data.messages.map(m => {
            const date = new Date(m.date);
            const dateStr = isNaN(date) ? m.date : date.toLocaleString('fr-CA', {dateStyle:'short', timeStyle:'short'});
            return `<tr class='border-t hover:bg-gray-50 ${m.is_read ? "text-gray-500" : "font-medium text-gray-800"}'>
                <td class='px-4 py-2'>${m.is_read ? '' : '<span class="inline-block w-2 h-2 rounded-full bg-blue-500"></span>'}</td>
                <td class='px-4 py-2 max-w-xs truncate text-xs'>${escHtml(m.sender)}</td>
                <td class='px-4 py-2 max-w-sm truncate'>${escHtml(m.subject)}</td>
                <td class='px-4 py-2 text-xs text-gray-400 whitespace-nowrap'>${dateStr}</td>
                <td class='px-4 py-2 text-center'>${m.has_attachment ? 'ğŸ“' : ''}</td>
                <td class='px-4 py-2 text-right whitespace-nowrap'>
                    <button onclick='emailMarkRead("${escAttr(m.uid)}", "${escAttr(folder)}")'
                        class='text-xs text-blue-500 hover:underline mr-2' title='Marquer comme lu'>âœ“ Lu</button>
                    <button onclick='emailMove("${escAttr(m.uid)}", "${escAttr(folder)}")'
                        class='text-xs text-green-500 hover:underline mr-2' title='DÃ©placer'>ğŸ“</button>
                    <button onclick='emailDelete("${escAttr(m.uid)}", "${escAttr(folder)}")'
                        class='text-xs text-red-400 hover:underline' title='Supprimer'>ğŸ—‘</button>
                </td>
            </tr>`;
        }).join('');
    } catch(e) {
        document.getElementById('emailLoading').classList.add('hidden');
    }
}

async function emailDelete(uid, folder) {
    if (!confirm('Supprimer cet email ?')) return;
    await fetch(`${API_URL}/email/messages/${uid}?folder=${encodeURIComponent(folder)}`,
        { method: 'DELETE', headers: { 'Authorization': authHeader } });
    loadEmails();
}

async function emailMove(uid, folder) {
    const dest = prompt('Dossier de destination :', 'PaperFree-TraitÃ©');
    if (!dest) return;
    await fetch(`${API_URL}/email/messages/${uid}/move?source_folder=${encodeURIComponent(folder)}&destination_folder=${encodeURIComponent(dest)}`,
        { method: 'POST', headers: { 'Authorization': authHeader } });
    loadEmails();
}

async function emailMarkRead(uid, folder) {
    await fetch(`${API_URL}/email/messages/${uid}/read?folder=${encodeURIComponent(folder)}`,
        { method: 'POST', headers: { 'Authorization': authHeader } });
    loadEmails();
}

async function syncAttachments() {
    showEmailMsg('Synchronisation lancÃ©e...', 'blue');
    const res = await fetch(`${API_URL}/email/sync-attachments`,
        { method: 'POST', headers: { 'Authorization': authHeader } });
    if (res.ok) showEmailMsg('âœ… Sync piÃ¨ces jointes en cours â€” vÃ©rifiez l\'onglet Documents', 'green');
    else        showEmailMsg('âŒ Erreur lors de la synchronisation', 'red');
}

async function purgePromo(dryRun) {
    const label = dryRun ? 'Simulation' : 'Purge';
    showEmailMsg(`${label} en cours... (peut prendre quelques secondes)`, 'blue');
    // Si simulation, on analyse TOUS les emails (older_than_days=0)
    const days = dryRun ? 0 : -1;
    const res = await fetch(`${API_URL}/email/purge-promotional?dry_run=${dryRun}&older_than_days=${days}`,
        { method: 'POST', headers: { 'Authorization': authHeader } });
    if (res.ok) {
        const r = await res.json();
        let msg;
        if (dryRun) {
            msg = `ğŸ‘ Simulation â€” ${r.total} email(s) au total, ${r.analysed} analysÃ©(s), `
                + `${r.too_recent} ignorÃ©(s) (trop rÃ©cents), ${r.deleted} promotionnel(s) dÃ©tectÃ©(s), `
                + `${r.kept} conservÃ©(s)`;
        } else {
            msg = `âœ… Purge terminÃ©e â€” ${r.analysed} analysÃ©(s), ${r.deleted} supprimÃ©(s), `
                + `${r.too_recent} ignorÃ©(s) (trop rÃ©cents), ${r.errors} erreur(s)`;
        }
        showEmailMsg(msg, r.deleted > 0 ? 'green' : 'blue');
        if (!dryRun) loadEmails();
    } else {
        const err = await res.json().catch(() => ({}));
        showEmailMsg(`âŒ Erreur : ${err.detail || 'Connexion ou config manquante'}`, 'red');
    }
}

function showEmailMsg(msg, color) {
    const el = document.getElementById('emailActionMsg');
    el.textContent = msg;
    el.className = `text-sm ${color === 'green' ? 'text-green-600' : color === 'red' ? 'text-red-500' : 'text-blue-500'}`;
    el.classList.remove('hidden');
    setTimeout(() => el.classList.add('hidden'), 5000);
}

async function loadEmailLogs() {
    try {
        const res = await fetch(`${API_URL}/email/logs?limit=50`, { headers: { 'Authorization': authHeader } });
        if (!res.ok) return;
        const logs = await res.json();
        const container = document.getElementById('emailLogs');
        if (!logs.length) { container.innerHTML = '<p class="text-xs text-gray-400">Aucune action enregistrÃ©e.</p>'; return; }
        const ACTION_LABELS = {
            'download_attachment': 'ğŸ“ PiÃ¨ce jointe',
            'delete_promo':        'ğŸ—‘ Promo supprimÃ©',
            'manual_delete':       'ğŸ—‘ Suppression manuelle',
            'move':                'ğŸ“ DÃ©placÃ©',
            'purge_promo':         'ğŸ§¹ Purge promotionnels',
        };
        container.innerHTML = logs.map(l => {
            const dt = new Date(l.created_at).toLocaleString('fr-CA', {dateStyle:'short', timeStyle:'short'});
            const label = ACTION_LABELS[l.action] || l.action;
            return `<div class='flex items-start gap-2 text-xs text-gray-600 py-1 border-b border-gray-50'>
                <span class='text-gray-400 whitespace-nowrap'>${dt}</span>
                <span class='font-medium'>${label}</span>
                ${l.subject ? `<span class='truncate text-gray-500'>${escHtml(l.subject)}</span>` : ''}
                ${l.detail  ? `<span class='text-gray-400 truncate'>${escHtml(l.detail)}</span>` : ''}
            </div>`;
        }).join('');
    } catch(e) {}
}

// â”€â”€â”€ Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('fileInput').onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const status = document.getElementById('uploadStatus');
    status.classList.remove('hidden');
    const formData = new FormData();
    formData.append('file', file);
    await fetch(`${API_URL}/upload`, {
        method: 'POST', body: formData, headers: { 'Authorization': authHeader }
    });
    e.target.value = '';
    setTimeout(() => status.classList.add('hidden'), 3000);
    loadDocuments();
};

// â”€â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escAttr(s) { return String(s||'').replace(/'/g,'&#39;').replace(/"/g,'&quot;'); }
function cap(s)     { return s.charAt(0).toUpperCase() + s.slice(1); }

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
checkStatus();
setInterval(() => { if (authHeader) loadDocuments(); }, 8000);
</script>
</body>
</html>
